<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Login Signup</title>
<link rel="stylesheet" href="{{ url_for('static', filename='Login_SignUp.css') }}">
</head>
<body>

<button id="meBtn" class="me-nav-btn">Me</button>

<div class="scene" id="authScene" style="display:none; opacity:0; transition: opacity 0.5s;">
  <div class="container" id="container">

    <form class="form-container sign-up" id="signupForm">
      <h2>Create Account</h2>
      <input type="text" name="name" placeholder="Full Name" required>
      <input type="email" name="email" placeholder="Email" required>
      <div class="password-wrapper">
        <input type="password" name="password" id="password" placeholder="Password" required>
        <span class="toggle-eye" data-target="password">üëÅ</span>
      </div>
      <div class="password-wrapper">
        <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
        <span class="toggle-eye" data-target="confirmPassword">üëÅ</span>
        <span id="successTick" class="tick">‚úì</span>
      </div>
      <small id="signupMsg" class="error-text"></small>
      <button id="createAccount" type="submit" disabled>Sign Up</button>
    </form>

    <form class="form-container sign-in" id="loginForm">
      <h2>Login</h2>
      <input type="email" name="email" placeholder="Email" required>
      <input type="password" name="password" placeholder="Password" required>
      <p class="forgot-link" id="forgotBtn" style="cursor:pointer; color:#666; font-size: 0.9rem; text-align:right;">Forgot password?</p>
      <small id="loginMsg" class="error-text"></small>
      <button type="submit">Login</button>
    </form>

    <div class="overlay-container">
      <div class="overlay">
        <div class="overlay-panel overlay-left">
          <h2>Welcome Back!</h2>
          <p>Already have an account?</p>
          <button id="signIn">Login</button>
        </div>
        <div class="overlay-panel overlay-right">
          <h2>Hello Friend!</h2>
          <p>Don't have an account?</p>
          <button id="signUp">Sign Up</button>
        </div>
      </div>
    </div>
  </div>

  <div class="forgot-modal" id="forgotModal">
    <div class="forgot-box">
      <h3>Reset Password</h3>
      <input type="email" id="forgotEmail" placeholder="Enter your email" style="width:90%;">
      <button id="sendForgot" style="margin-bottom: 10px;">Get Password</button>
      <button id="closeForgot" style="background:#666;">Close</button>
      <small id="forgotMsg" class="error-text" style="display:block; margin-top:10px;"></small>
    </div>
  </div>
</div>

<div id="profileSection" class="profile-card" style="display:none;">
    <div class="profile-header">
        <div class="initials-circle" id="userInitials"></div>
        <div class="user-meta">
            <h2 id="profName"></h2>
            <p id="profEmail" style="color: #666;"></p>
        </div>
    </div>

    <div class="info-row">
        <div class="row-top">
            <span class="label" style="font-weight:bold; color:#444;">Delivery Address</span>
            <button class="cyan-add-btn" id="addrBtn" onclick="toggleInput('address')">+ADD</button>
        </div>
        <div id="addrDisplay" class="display-text">Not added</div>
        
        <div id="addressInputArea" class="input-area" style="display:none; padding-top: 10px;">
            <div class="form-row single">
                <div class="form-group">
                    <label>House No. / Flat No. / Building</label>
                    <input type="text" id="profileHouse" placeholder="e.g., Flat 101, Building A">
                </div>
            </div>
            <div class="form-row single">
                <div class="form-group">
                    <label>Road / Area / Colony</label>
                    <input type="text" id="profileRoad" placeholder="e.g., MG Road, Sector 15">
                </div>
            </div>
            <div class="form-row triple">
                <div class="form-group"><label>City</label><input type="text" id="profileCity" placeholder="City"></div>
                <div class="form-group"><label>State</label><input type="text" id="profileState" placeholder="State"></div>
                <div class="form-group"><label>Pincode</label><input type="text" id="profilePincode" placeholder="6-digit" maxlength="6"></div>
            </div>
            <small id="profileAddressMsg" class="error-text" style="height:auto; text-align:center;"></small>
            <button class="save-btn" onclick="saveAddress()">Save Address</button>
        </div>
    </div>

    <div class="info-row">
        <div class="row-top">
            <span class="label" style="font-weight:bold; color:#444;">Phone No.</span>
            <button class="cyan-add-btn" id="phoneBtn" onclick="toggleInput('phone')">+ADD</button>
        </div>
        <div id="phoneDisplay" class="display-text">Not added</div>
        <div id="phoneInputArea" class="input-area" style="display:none;">
            <input type="text" id="phoneText" placeholder="10-digit number" maxlength="10">
            <button class="save-btn" onclick="saveField('phone')">Save Phone</button>
            <a href="/checkout" 
       style="display:block; text-align:center; background:#00c851; color:white; padding:12px; border-radius:8px; text-decoration:none; font-weight:bold; margin-top:20px;">
       üõí Continue to Checkout
    </a>
    <a href="/logout" class="logout-link">Logout</a>
    </div>
</div>

<script>
const authScene = document.getElementById("authScene");
const container = document.getElementById("container");
const profileSection = document.getElementById("profileSection");

document.getElementById("meBtn").onclick = () => {
    authScene.style.display = "block";
    setTimeout(() => { authScene.style.opacity = "1"; }, 10);
    profileSection.style.display = "none";
};

const password = document.getElementById("password");
const confirmPassword = document.getElementById("confirmPassword");
const tick = document.getElementById("successTick");
const createBtn = document.getElementById("createAccount");

document.getElementById("signUp").onclick = () => container.classList.add("active");
document.getElementById("signIn").onclick = () => container.classList.remove("active");

function validatePasswords(){
  const msg = document.getElementById("signupMsg");
  if(confirmPassword.value === "") {
    msg.textContent = ""; tick.classList.remove("show"); createBtn.disabled = true; return;
  }
  if(password.value !== confirmPassword.value){
    msg.textContent = "Passwords do not match"; msg.style.color = "#ff4d4d";
    tick.classList.remove("show"); createBtn.disabled = true;
  } else {
    msg.textContent = "Passwords match!"; msg.style.color = "#00c851";
    tick.classList.add("show"); createBtn.disabled = false;
  }
}
password.addEventListener("input", validatePasswords);
confirmPassword.addEventListener("input", validatePasswords);

document.querySelectorAll(".toggle-eye").forEach(icon => {
  icon.addEventListener("click", () => {
    const input = document.getElementById(icon.dataset.target);
    input.type = input.type === "password" ? "text" : "password";
    icon.textContent = input.type === "password" ? "üëÅ" : "üôà";
  });
});

async function handleSubmission(id, url, msgId) {
  const form = document.getElementById(id);
  form.onsubmit = async (e) => {
    e.preventDefault();
    const msg = document.getElementById(msgId);
    const formData = new FormData(form);
    
    try {
      const response = await fetch(url, { method: "POST", body: formData });
      const data = await response.json();
      
      msg.textContent = data.message || (data.success ? "Success!" : "Error");
      msg.style.color = data.success ? "#00c851" : "#ff4d4d";
      
      if(data.success && id === "signupForm") form.reset();
      
      if(data.success && id === "loginForm") {
          authScene.style.opacity = "0";
          setTimeout(() => {
              authScene.style.display = "none";
              showProfile(data); 
          }, 500);
      }
    } catch (err) {
      msg.textContent = "Could not connect to server.";
    }
  };
}

handleSubmission("signupForm", "/signup", "signupMsg");
handleSubmission("loginForm", "/login", "loginMsg");

function showProfile(user) {
    profileSection.style.display = "block";
    document.getElementById("profName").innerText = user.name;
    document.getElementById("profEmail").innerText = user.email;
    document.getElementById("userInitials").innerText = user.name.charAt(0).toUpperCase();
    
    // Auto-fill existing address components if available
    if(user.address) {
        let parts = user.address.split(', ');
        if(parts.length >= 4) {
            document.getElementById('profileHouse').value = parts[0] || '';
            document.getElementById('profileRoad').value = parts[1] || '';
            document.getElementById('profileCity').value = parts[2] || '';
            let statePin = parts[3].split(' - ');
            document.getElementById('profileState').value = statePin[0] || '';
            document.getElementById('profilePincode').value = statePin[1] || '';
        }
    }
    
    if(user.phone) document.getElementById("phoneText").value = user.phone;

    updateFieldUI('address', user.address);
    updateFieldUI('phone', user.phone);
}

function toggleInput(type) {
    const area = document.getElementById(type === 'address' ? 'addressInputArea' : 'phoneInputArea');
    area.style.display = area.style.display === "none" ? "block" : "none";
    if (type === 'phone') area.style.display = area.style.display === "block" ? "flex" : "none";
}

// Handle Single Phone Update
async function saveField(field) {
    const inputId = field === 'address' ? 'addrText' : 'phoneText';
    const value = document.getElementById(inputId).value;
    
    const response = await fetch('/update_profile', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ field: field, value: value })
    });
    const result = await response.json();
    if(result.success) {
        updateFieldUI(field, value);
        toggleInput(field);
    }
}

// Handle 5-Box Address Update
async function saveAddress() {
    const house = document.getElementById('profileHouse').value.trim();
    const road = document.getElementById('profileRoad').value.trim();
    const city = document.getElementById('profileCity').value.trim();
    const state = document.getElementById('profileState').value.trim();
    const pincode = document.getElementById('profilePincode').value.trim();
    const msg = document.getElementById('profileAddressMsg');

    if (!house || !road || !city || !state || !pincode) {
        msg.textContent = "Please fill in all address fields.";
        msg.style.color = "#ff4d4d"; return;
    }
    if (!/^\d{6}$/.test(pincode)) {
        msg.textContent = "Please enter a valid 6-digit Pincode.";
        msg.style.color = "#ff4d4d"; return;
    }

    const fullAddress = `${house}, ${road}, ${city}, ${state} - ${pincode}`;
    msg.textContent = "Saving...";
    msg.style.color = "#00d4ff";

    const response = await fetch('/update_profile', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ field: 'address', value: fullAddress })
    });
    const result = await response.json();
    
    if(result.success) {
        updateFieldUI('address', fullAddress);
        toggleInput('address');
        msg.textContent = ""; 
    } else {
        msg.textContent = "Error saving address.";
        msg.style.color = "#ff4d4d";
    }
}

function updateFieldUI(field, value) {
    if(value && value !== "") {
        const displayId = field === 'address' ? 'addrDisplay' : 'phoneDisplay';
        const btnId = field === 'address' ? 'addrBtn' : 'phoneBtn';
        document.getElementById(displayId).innerText = value;
        document.getElementById(btnId).innerText = "Edit";
    }
}

// Forgot Password Modal
const modal = document.getElementById("forgotModal");
document.getElementById("forgotBtn").onclick = () => modal.classList.add("active");
document.getElementById("closeForgot").onclick = () => {
  modal.classList.remove("active");
  document.getElementById("forgotMsg").textContent = "";
};
document.getElementById("sendForgot").onclick = async () => {
  const email = document.getElementById("forgotEmail").value;
  const msg = document.getElementById("forgotMsg");
  const response = await fetch("/forgot", { method: "POST", body: new URLSearchParams({ email }) });
  const data = await response.json();
  msg.textContent = data.message;
  msg.style.color = data.success ? "#00c851" : "#ff4d4d";
};
</script>
</body>
</html>